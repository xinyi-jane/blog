---
// Admin é¡µé¢ - æœåŠ¡ Decap CMS
---

<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å†…å®¹ç®¡ç†</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
    }
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    #nc-root {
      min-height: 100vh;
    }
    .debug-info {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 15px;
      max-width: 400px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      font-size: 12px;
      z-index: 9999;
      display: none;
    }
    .debug-info.show {
      display: block;
    }
    .debug-info h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #333;
    }
    .debug-info pre {
      margin: 5px 0;
      padding: 5px;
      background: #f5f5f5;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 11px;
    }
    .debug-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      cursor: pointer;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      z-index: 10000;
    }
  </style>
</head>
<body>
  <div id="nc-root" class="loading">æ­£åœ¨åŠ è½½å†…å®¹ç®¡ç†ç³»ç»Ÿ...</div>
  
  <!-- è°ƒè¯•ä¿¡æ¯é¢æ¿ -->
  <button class="debug-toggle" onclick="toggleDebug()" title="æ˜¾ç¤º/éšè—è°ƒè¯•ä¿¡æ¯">ğŸ”</button>
  <div id="debug-info" class="debug-info">
    <h3>è°ƒè¯•ä¿¡æ¯</h3>
    <div id="debug-content"></div>
  </div>
  
  <!-- Include the script that builds the page and powers Decap CMS -->
  <!-- Decap CMS ä¼šè‡ªåŠ¨ä» /admin/config.yml åŠ è½½é…ç½® -->
  <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
  <script>
    // è°ƒè¯•ä¿¡æ¯æ”¶é›†
    const debugInfo = {
      token: null,
      cmsAvailable: false,
      backend: null,
      currentUser: null,
      errors: []
    };
    
    function updateDebugInfo() {
      const content = document.getElementById('debug-content');
      if (!content) return;
      
      let html = '<pre>Token: ' + (debugInfo.token ? 'âœ“ å·²ä¿å­˜' : 'âœ— æœªæ‰¾åˆ°') + '</pre>';
      html += '<pre>CMS Available: ' + (debugInfo.cmsAvailable ? 'âœ“' : 'âœ—') + '</pre>';
      html += '<pre>Backend: ' + (debugInfo.backend ? debugInfo.backend : 'æœªåˆå§‹åŒ–') + '</pre>';
      html += '<pre>Current User: ' + (debugInfo.currentUser ? JSON.stringify(debugInfo.currentUser, null, 2) : 'æœªè·å–') + '</pre>';
      if (debugInfo.errors.length > 0) {
        html += '<pre style="color: red;">Errors: ' + debugInfo.errors.join(', ') + '</pre>';
      }
      content.innerHTML = html;
    }
    
    // å°† toggleDebug å‡½æ•°å®šä¹‰åœ¨å…¨å±€ä½œç”¨åŸŸ
    window.toggleDebug = function() {
      const panel = document.getElementById('debug-info');
      if (panel) {
        panel.classList.toggle('show');
      }
    };
    
    // å…¨å±€é”™è¯¯å¤„ç†
    window.addEventListener('unhandledrejection', function(event) {
      if (event.reason && event.reason.message && event.reason.message.includes('message port closed')) {
        event.preventDefault();
        console.warn('Ignored message port error (likely from browser extension)');
        return;
      }
      debugInfo.errors.push(event.reason ? event.reason.toString() : 'Unknown error');
      updateDebugInfo();
      console.error('Unhandled promise rejection:', event.reason);
    });
    
    // å¤„ç† OAuth å›è°ƒåçš„ token
    (function() {
      // æ£€æŸ¥ URL ä¸­çš„ token å‚æ•°
      const urlParams = new URLSearchParams(window.location.search);
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const token = urlParams.get('token') || hashParams.get('token');
      
      if (token) {
        console.log('Token found in URL, saving to localStorage...');
        
        try {
          const userData = {
            token: token,
            backend: 'github'
          };
          
          localStorage.setItem('netlify-cms-user', JSON.stringify(userData));
          sessionStorage.setItem('netlify-cms-user', JSON.stringify(userData));
          console.log('Token saved to localStorage:', userData);
          
          debugInfo.token = token.substring(0, 20) + '...';
          updateDebugInfo();
          
          const cleanUrl = window.location.pathname + (window.location.hash.split('?')[0] || '');
          window.history.replaceState({}, document.title, cleanUrl);
          
          setTimeout(function() {
            window.location.reload();
          }, 100);
        } catch (e) {
          console.error('Failed to save token:', e);
          debugInfo.errors.push('Failed to save token: ' + e.message);
          updateDebugInfo();
        }
        return;
      }
      
      // æ£€æŸ¥å·²ä¿å­˜çš„ç”¨æˆ·ä¿¡æ¯
      const savedUser = localStorage.getItem('netlify-cms-user');
      if (savedUser) {
        try {
          const userData = JSON.parse(savedUser);
          if (userData.token) {
            console.log('Found saved token in localStorage:', userData);
            debugInfo.token = userData.token.substring(0, 20) + '...';
            updateDebugInfo();
            
            // ç­‰å¾…å¹¶æ£€æŸ¥ Decap CMS
            function checkCMS() {
              if (window.CMS) {
                debugInfo.cmsAvailable = true;
                updateDebugInfo();
                
                try {
                  const backend = window.CMS.getBackend();
                  if (backend) {
                    debugInfo.backend = backend.name || 'Unknown';
                    updateDebugInfo();
                    
                    // å°è¯•è·å–å½“å‰ç”¨æˆ·
                    if (backend.currentUser) {
                      backend.currentUser().then(function(user) {
                        debugInfo.currentUser = user;
                        updateDebugInfo();
                        console.log('Current user:', user);
                      }).catch(function(err) {
                        console.warn('Failed to get current user:', err);
                        debugInfo.errors.push('Get user error: ' + err.message);
                        updateDebugInfo();
                      });
                    }
                    
                    // å°è¯•è®¤è¯
                    if (backend.authenticate) {
                      backend.authenticate().then(function() {
                        console.log('Authentication successful');
                        // é‡æ–°è·å–ç”¨æˆ·ä¿¡æ¯
                        if (backend.currentUser) {
                          backend.currentUser().then(function(user) {
                            debugInfo.currentUser = user;
                            updateDebugInfo();
                          });
                        }
                      }).catch(function(err) {
                        console.warn('Authentication check failed:', err);
                        debugInfo.errors.push('Auth error: ' + err.message);
                        updateDebugInfo();
                      });
                    }
                  } else {
                    setTimeout(checkCMS, 500);
                  }
                } catch (e) {
                  console.warn('Error accessing backend:', e);
                  debugInfo.errors.push('Backend access error: ' + e.message);
                  updateDebugInfo();
                  setTimeout(checkCMS, 500);
                }
              } else {
                setTimeout(checkCMS, 500);
              }
            }
            
            if (document.readyState === 'complete') {
              setTimeout(checkCMS, 1000);
            } else {
              window.addEventListener('load', function() {
                setTimeout(checkCMS, 1000);
              });
            }
          }
        } catch (e) {
          console.error('Failed to parse saved user data:', e);
          debugInfo.errors.push('Parse error: ' + e.message);
          updateDebugInfo();
        }
      } else {
        debugInfo.errors.push('No token found in localStorage');
        updateDebugInfo();
      }
    })();
    
    // å®šæœŸæ›´æ–°è°ƒè¯•ä¿¡æ¯
    setInterval(updateDebugInfo, 2000);
  </script>
</body>
</html>
