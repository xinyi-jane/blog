---
import Layout from '../../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts', ({ data }) => 
    !data.draft && data.channel === 'work'
  );
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

type Props = {
  post: CollectionEntry<'posts'>;
};

const { post } = Astro.props;
const { Content } = await post.render();
const allPosts = await getCollection('posts', ({ data }) => 
  !data.draft && data.channel === 'work'
);
const sortedPosts = allPosts.sort((a, b) => 
  a.data.date.getTime() - b.data.date.getTime()
);
const currentIndex = sortedPosts.findIndex(p => p.slug === post.slug);
const prevPost = currentIndex > 0 ? sortedPosts[currentIndex - 1] : null;
const nextPost = currentIndex < sortedPosts.length - 1 ? sortedPosts[currentIndex + 1] : null;
---

<Layout 
  title={post.data.title} 
  description={post.data.description || post.data.title}
  image={post.data.cover}
>
  <article class="bg-white/70 backdrop-blur-sm rounded-2xl p-8 md:p-12 shadow-sm">
    {post.data.cover && (
      <div class="mb-8 rounded-xl overflow-hidden shadow-md">
        <img src={post.data.cover} alt={post.data.title} class="w-full h-64 md:h-96 object-cover" />
      </div>
    )}
    
    <header class="mb-10 pb-6 border-b border-sky-100">
      <div class="flex items-center gap-2 mb-4">
        <span class="px-3 py-1 bg-sky-100 text-sky-600 rounded-full text-sm font-medium">ğŸ’¼ å·¥ä½œ</span>
        <time class="text-sm text-gray-400">{post.data.date.toLocaleDateString('zh-CN', { year: 'numeric', month: 'long', day: 'numeric' })}</time>
      </div>
      <h1 class="text-4xl md:text-5xl font-bold mb-4 text-gray-800 leading-tight">{post.data.title}</h1>
      {post.data.description && (
        <p class="text-lg text-gray-600 mt-4">{post.data.description}</p>
      )}
      {post.data.tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mt-6">
          {post.data.tags.map((tag) => (
            <a href={`/tags/${tag}`} class="px-3 py-1 bg-sky-50 text-sky-600 rounded-full text-sm hover:bg-sky-100 transition-colors">
              #{tag}
            </a>
          ))}
        </div>
      )}
    </header>

    <div class="prose prose-lg max-w-none prose-headings:text-gray-800 prose-p:text-gray-700 prose-a:text-sky-600 prose-a:no-underline hover:prose-a:underline prose-strong:text-gray-800 prose-code:text-sky-600 prose-code:bg-sky-50 prose-code:px-1 prose-code:py-0.5 prose-code:rounded">
      <Content />
    </div>

    {post.data.gallery && post.data.gallery.length > 0 && (
      <section class="mt-12 pt-8 border-t border-sky-100">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">å›¾ç‰‡é›†</h2>
        <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
          {post.data.gallery.map((img) => (
            <div class="overflow-hidden rounded-xl shadow-sm hover:shadow-md transition-shadow">
              <img src={img} alt="" class="w-full h-48 object-cover hover:scale-105 transition-transform duration-300" />
            </div>
          ))}
        </div>
      </section>
    )}

    <nav class="mt-12 pt-8 border-t border-sky-100">
      <div class="flex justify-between gap-4">
        {prevPost ? (
          <a href={`/work/${prevPost.slug}`} class="group flex-1 p-4 bg-sky-50 rounded-xl hover:bg-sky-100 transition-colors">
            <p class="text-sm text-gray-400 mb-1">ä¸Šä¸€ç¯‡</p>
            <p class="text-sky-600 font-medium group-hover:text-sky-700">â† {prevPost.data.title}</p>
          </a>
        ) : (
          <span></span>
        )}
        {nextPost ? (
          <a href={`/work/${nextPost.slug}`} class="group flex-1 p-4 bg-sky-50 rounded-xl hover:bg-sky-100 transition-colors text-right">
            <p class="text-sm text-gray-400 mb-1">ä¸‹ä¸€ç¯‡</p>
            <p class="text-sky-600 font-medium group-hover:text-sky-700">{nextPost.data.title} â†’</p>
          </a>
        ) : (
          <span></span>
        )}
      </div>
    </nav>
  </article>
</Layout>

